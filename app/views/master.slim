== styled_flash
div.main.mui-container
  div.app-bar.center
    = @player.name
    | (мастер)
  div.app-bar.mui-container-fluid
    div.mui-row
      div.center.mui-col-xs-2
        a href='/master/msg' Сообщ
        - players = @player.adventure.players.where(is_master: false).order(:name)
        - players.each do |p|
          span id="chat-indicator#{p.id}" class="chat-indicator no-messages" data-chat-id="#{p.id}"
            i.iw-bell
      div.center.mui-col-xs-2.mui--divider-left
        a href='/note' Заметки
      div.center.mui-col-xs-4.mui--divider-left
        a href='/rules' Правила
      div.center.mui-col-xs-2.mui--divider-left
        a href='/map'
          i.iw-map
      div.center.mui-col-xs-2.mui--divider-left
        a href='/logout'
          i.iw-cross

  div.dnd-flex-row.mui--z2.fullwidth
    span.dnd-flex-grow1.mui--text-center onclick="toggle_item('fight');"
      = t('fight.fights')
      |:&nbsp;
      span#fight-fase
    span.mui--text-right
      a href="#" onclick="del_fight();"
        i.icon-minus-sign
      | &nbsp;
      a href="#" onclick="new_fight();"
        i.icon-plus-sign
      | &nbsp;&nbsp;
  div#fight.fight.mui--hide
    div.dnd-flex-cont.fullwidth
      span
        = t('fight.round')
        |:&nbsp;&nbsp;
      span#fight-round.mui--divider-right
        | ...
      |&nbsp;
      span#start-fight-btn.mui-btn.mui-btn--small.mui-btn--primary.mui-btn--raised onclick="start_fight();"
        = t('fight.start')
      |&nbsp;
      span#next-fighter-btn.mui-btn.mui-btn--small.mui-btn--primary.mui-btn--raised.mui--hide onclick="next_fighter();"
        = t('fight.next')
    div.dnd-flex-cont.mui--z2.fullwidth
      span.mui-select.dnd-flex-grow1
        label for='race_id'
          = t('npc-type')
        select name='race_id' id='npc-type'
          - NpcType.order(:id).each do |r|
            option value="#{r.id}" label='#{t("char.#{r.name}")}'
              = t("char.#{r.name}")
      span.dnd-1em
        |&nbsp;
      span.dnd-7em.mui-btn.mui-btn--small.mui-btn--primary.mui-btn--raised onclick="add_npc();"
        = t('add-npc')
      span.dnd-1em
        |&nbsp;
      span.mui-textfield.dnd-3em
        input#npc-num type="text" placeholder="1"
      span.dnd-1em
        |&nbsp;

    div.dnd-flex-row.fullwidth#fight-list


  div.dnd-flex-row.mui--z2.fullwidth
    span.dnd-flex-grow1.mui--text-center onclick="toggle_item('fight-group');"
      = t('fight-groups')
    span.mui--text-right
      input#group-name.mui--hide type='text'
    span.mui--text-right
      a href="#" onclick="new_fight_group();"
        i.icon-plus-sign
      | &nbsp;&nbsp;
  div#fight-group.fight-group.mui--hide
    div.dnd-flex-cont.mui--z2.fullwidth
      span.mui-select.dnd-flex-grow1
        label for='grp_race_id'
          = t('grp-npc-type')
        select name='grp_race_id' id='grp-npc-type'
          - NpcType.order(:id).each do |r|
            option value="#{r.id}" label='#{t("char.#{r.name}")}'
              = t("char.#{r.name}")
      span.dnd-1em
        |&nbsp;
      span.mui-textfield.dnd-3em
        input#grp-npc-num type="text" placeholder="1"
      span.dnd-1em
        |&nbsp;
    div.dnd-flex-row.fullwidth#fight-group-list

javascript:
  var secret="#{{@user.secret}}";
  var player_str='?player_id='+"#{{@player.id}}";
  function on_websocket_open(ws){
    //ws.send(secret+': get_master');
    ws.send(secret+': player/prefs');
    ws.send(secret+': fight/get_fight');
    ws.send(secret+': fight/get_groups');
  }

  function new_fight(){
    ws.send(secret+': fight/new');
  }

  function new_fight_group(){
    var input = document.getElementById('group-name');
    var is_hidden = input.classList.contains('mui--hide');
    if(is_hidden){
      input.value = '';
      input.classList.remove('mui--hide');
    }
    else{
      var text = input.value;
      input.classList.add('mui--hide');
      ws.send(secret+': fight/new-group '+text);
    }
  }

  function del_fight(){
    ws.send(secret+': fight/del');
  }

  function add_npc() {
    var npc_type = document.getElementById("npc-type").value;
    var npc_num = get_int_value('npc-num');
    if(Number.isNaN(npc_num))
      npc_num = 1;
    ws.send(secret+': fight/new-npc '+npc_type+' '+npc_num);
  }

  function fight_step_down(index){
    ws.send(secret+': fight/fighter-step '+fighters[index].id+' '+fighters[index].is_npc+' -');
  }

  function fight_step_up(index){
    ws.send(secret+': fight/step '+fighters[index].id+' '+fighters[index].is_npc+' +');
  }

  function fighter_delete(index){
    ws.send(secret+': fight/fighter-del '+fighters[index].id+' '+fighters[index].is_npc);
  }

  function fighter_restore(index){
    ws.send(secret+': fight/fighter-restore '+fighters[index].id+' '+fighters[index].is_npc);
  }

  // change monster HP 
  function f_hp_modify(c,mod){
    var v = get_over_value(null);
    if(v === null){
      if(mod=='=')
        return
      v=1
    }
    if(mod=='+'){
      fighters[c].hp += v;
    }
    else if(mod=='-'){
      fighters[c].hp -= v;
    }
    else{
      fighters[c].hp = v;
    }
    ws.send(secret+': fight/hp '+fighters[c].id+'/'+
      (fighters[c].is_npc ? 'n' : 'p')+'='+fighters[c].hp);
  }

  function f_hp_plus(c) { f_hp_modify(c,'+') }
  function f_hp_minus(c){ f_hp_modify(c,'-') }
  function f_hp_set(c)  { f_hp_modify(c,'=') }

  // change monster MAX HP 
  function f_max_hp_modify(c,mod){
    var v = get_over_value(null);
    if(v === null){
      if(mod=='=')
        return
      v=1
    }
    if(mod=='+'){
      fighters[c].max_hp += v;
    }
    else if(mod=='-'){
      fighters[c].max_hp -= v;
    }
    else{
      fighters[c].max_hp = v;
    }
    ws.send(secret+': fight/max_hp '+fighters[c].id+'='+fighters[c].max_hp);
  }

  function f_max_hp_plus(c) { f_max_hp_modify(c,'+') }
  function f_max_hp_minus(c){ f_max_hp_modify(c,'-') }
  function f_max_hp_set(c)  { f_max_hp_modify(c,'=') }

  // change monster armor class 
  function f_ac_modify(c,mod){
    var v = get_over_value(null);
    if(v === null){
      if(mod=='=')
        return
      v=1
    }
    if(mod=='+'){
      fighters[c].armor_class += v;
    }
    else if(mod=='-'){
      fighters[c].armor_class -= v;
    }
    else{
      fighters[c].armor_class = v;
    }
    ws.send(secret+': fight/ac '+fighters[c].id+'='+fighters[c].armor_class);
  }

  function f_ac_plus(c) { f_ac_modify(c,'+') }
  function f_ac_minus(c){ f_ac_modify(c,'-') }
  function f_ac_set(c)  { f_ac_modify(c,'=') }

  // change player initiative manually
  function f_init_modify(c,mod){
    var v = get_over_value(null);
    if(v === null){
      if(mod=='=')
        return
      v=1
    }
    if(mod=='+'){
      fighters[c].initiative += v;
    }
    else if(mod=='-'){
      fighters[c].initiative -= v;
    }
    else{
      fighters[c].initiative = v;
    }
    ws.send(secret+': fight/initiative '+fighters[c].id+'='+fighters[c].initiative);
  }

  function f_init_plus(c) { f_init_modify(c,'+') }
  function f_init_minus(c){ f_init_modify(c,'-') }
  function f_init_set(c)  { f_init_modify(c,'=') }

  function start_fight(){
    ws.send(secret+': fight/next-fase');
  }

  function next_fighter(){
    ws.send(secret+': fight/next');
  }

  // add npc to group
  function new_npc_group(id){
    var npc_type = document.getElementById("grp-npc-type").value;
    var npc_num = get_int_value('grp-npc-num');
    if(Number.isNaN(npc_num))
      npc_num = 1;
    ws.send(secret+': fight/add-to-group '+id+' '+npc_type+' '+npc_num);
  }

  // del npc to group
  function del_npc_group(id,npc_id){
    ws.send(secret+': fight/del-from-group '+id+' '+npc_id);

  }
  // del group
  function kill_npc_group(id){
    ws.send(secret+': fight/del-group '+id);
  }
  /////////////////////////////////////////////////////////////////////////////
  function render_fight_group(grp) {
    var str = '<div class="mui-row fullwidth" onclick="toggle_item(\'fight-group-'+grp.id+'\');">'+
      '<div class="mui--pull-left">'+
      '<a href="#" onclick="kill_npc_group('+grp.id+');">'+
        '<i class="icon-circledelete"></i></a>&nbsp;'+
        grp.name+'</div><div class="mui--pull-right">'+
      // '<a href="#" onclick="del_npc_group('+grp.id+');">'+
      //   '<i class="icon-minus-sign"></i></a>'+
      '<a href="#" onclick="new_npc_group('+grp.id+');">'+
        '<i class="icon-plus-sign"></i></a></div></div>'+
      '<div id="fight-group-'+grp.id+'" class="fullwidth dnd-flex-row">';
    var npc = grp.npc;
    var len = npc.length;
    for (var i = 0; i <len; i++) {
      var arg = {i: i, grp: grp.id};
      str += 
        '<div class="dnd-flex-cont fullwidth dnd-npc-fighter">'+
          //'<div class="dnd-1em dnd-flex-noresize">'+
          //</div>'+
          '<div class="dnd-flex-grow1">'+
            '<a href="#" onclick="del_npc_group('+grp.id+','+npc[i].id+')"><i class="icon-circledelete"></i></a>&nbsp;'+
            npc[i].name+' ('+
          npc[i].npc_type+')</div><div class="dnd-5em dnd-flex-noresize center mui--divider-left">'+
            '<a class="dnd-btn dnd-btn--primary" href="#" onclick="formModal(overForm3(\'g_hp_plus\',\'g_hp_minus\',\'g_hp_set\','+arg+'));">'+
          npc[i].hp+
              '</a> / <a class="dnd-btn dnd-btn--primary" href="#" onclick="formModal(overForm3(\'g_max_hp_plus\',\'g_max_hp_minus\',\'g_max_hp_set\','+arg+'));">'+
          npc[i].max_hp+'</a></div><div class="dnd-5em dnd-flex-noresize center mui--divider-left">'+
            '<a class="dnd-btn dnd-btn--primary" href="#" onclick="formModal(overForm3(\'g_ac_plus\',\'g_ac_minus\',\'g_ac_set\','+arg+'));">'+
          npc[i].armor_class+
            '</a></div><div class="dnd-5em dnd-flex-noresize center mui--divider-left">'+
          npc[i].initiative+'</div>'+
        '</div>'; //cont
    }
    return str+'</div>'; //row
  }

  function render_fight_groups() {
    var str = '<div class="dnd-flex-row fullwidth dnd-grp-title"><div class="fullwidth dnd-flex-cont">'+
      '<div class="dnd-flex-grow1 mui--text-left">Name'+
      '</div><div class="dnd-5em dnd-flex-noresize center mui--divider-left">HP / MAX HP</div>'+
      '<div class="dnd-5em dnd-flex-noresize center mui--divider-left">Armor class</div>'+
      '<div class="dnd-5em dnd-flex-noresize center mui--divider-left">Initiative</div></div></div>';
    _.forEach(groups, function(grp){
      str += render_fight_group(grp);
    });
    set_html('fight-group-list',str);
  }

script src="files/common.js"
